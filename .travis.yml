language: node_js
matrix:
    allow_failures:
        - node_js: "5"
node_js:
    - "0.10"
    - "0.12"
    - "4"
    - "5"
services:
    - couchdb
env:
    global:
        - NODE_ENV=test
        - DEBUG=true

before_install:
    - travis_retry npm -g install npm@latest-2
    - travis_retry npm install forever mocha coffee-script -g
    - travis_retry npm install cozy-controller
    - sudo sed -i -e 's/^Defaults\tsecure_path.*$//' /etc/sudoers
    - sudo forever start -o forever-ds.log -e forever-ds-err.log node_modules/cozy-controller/bin/cozy-controller
    - ps aux | grep controller
    - sleep 5
    - cat forever-ds.log
    - sudo chmod a+r /etc/cozy/stack.token

script: 'npm test'

after_failure:
    - ps aux | grep controller
    - cat forever-ds.log
    - cat forever-ds-err.log
    - curl http://localhost:9002/
    - sudo netstat -lntp
    - ls -l /etc/cozy/
    - cat /etc/cozy/stack.token
